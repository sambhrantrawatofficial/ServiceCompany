@model ServiceProvidingCompany.Models.Booking
@{
    ViewData["Title"] = "Service Booking";
}

<div class="form-card">
    <div class="form-header text-center">
        <h2>Service Booking</h2>
        <p>Please fill in the details below</p>
    </div>

    <form asp-action="Booking"
          asp-controller="Booking"
          method="post"
          id="bookingForm">

        @Html.AntiForgeryToken()

        <!-- Address -->
        <div class="form-group">
            <label asp-for="Address"></label>
            <textarea asp-for="Address" class="form-control" rows="3" minlength="5" required></textarea>
            <span asp-validation-for="Address" class="text-danger"></span>
        </div>

        <!-- Landmark -->
        <div class="form-group">
            <label asp-for="Landmark"></label>
            <textarea asp-for="Landmark" class="form-control" rows="2" required></textarea>
            <span asp-validation-for="Landmark" class="text-danger"></span>
        </div>

        <!-- Date -->
        <div class="form-group">
            <label asp-for="Date"></label>
            <input asp-for="Date" type="date" class="form-control" required />
            <span asp-validation-for="Date" class="text-danger"></span>
        </div>

        <!-- Time Slots -->
        <div class="form-group">
            <label asp-for="PreferredTimeSlot1"></label>
            <input asp-for="PreferredTimeSlot1" type="time" class="form-control" required />
        </div>

        <div class="form-group">
            <label asp-for="PreferredTimeSlot2"></label>
            <input asp-for="PreferredTimeSlot2" type="time" class="form-control" required />
        </div>

        <!-- Phone -->
        <div class="form-group">
            <label asp-for="Phone"></label>
            <input asp-for="Phone" class="form-control" minlength="10" maxlength="15" required />
            <span asp-validation-for="Phone" class="text-danger"></span>
        </div>

        <!-- Notes -->
        <div class="form-group">
            <label asp-for="Notes"></label>
            <textarea asp-for="Notes" class="form-control" rows="2"></textarea>
        </div>

        <!-- Payment -->
        <div class="form-group mt-3">
            <label class="fw-bold">Payment Method</label>

            <div class="form-check">
                <input class="form-check-input" type="radio" asp-for="Payment" value="UPI" required />
                <label class="form-check-label">UPI</label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="radio" asp-for="Payment" value="Card" id="paymentCard" />
                <label class="form-check-label">Card</label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="radio" asp-for="Payment" value="CashOnDelivery" />
                <label class="form-check-label">Cash on Delivery</label>
            </div>

            <span asp-validation-for="Payment" class="text-danger"></span>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-3">
            Confirm Booking
        </button>
    </form>
</div>

<!-- ================= PAYMENT MODAL ================= -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Complete Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <p>Please complete your payment to confirm booking</p>
                <div id="paypal-button-container"></div>
            </div>

        </div>
    </div>
</div>

@section Scripts {

    <!-- PayPal Sandbox SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AdTBYKKcMfjmSAyguBM3i3QT_hySokZZEMPOkMHSuMg2hSZX-w37nvIDgo9O-wmDY_X789hmz__crAUT&currency=USD"></script>

    <script>
        const form = document.getElementById("bookingForm");
        const cardRadio = document.getElementById("paymentCard");
        const modalEl = document.getElementById("paymentModal");
        const paymentModal = new bootstrap.Modal(modalEl);

        let paypalRendered = false;

        form.addEventListener("submit", function (e) {
            if (cardRadio.checked) {
                e.preventDefault();
                paymentModal.show();

                if (!paypalRendered) {
                    renderPayPal();
                    paypalRendered = true;
                }
            }
        });

        function renderPayPal() {
            paypal.Buttons({
                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: '2.00' }
                        }]
                    });
                },

                onApprove: function (data, actions) {
                    return actions.order.capture().then(function (details) {
                        const input = document.createElement("input");
                        input.type = "hidden";
                        input.name = "PayPalOrderId";
                        input.value = details.id;
                        form.appendChild(input);

                        paymentModal.hide();
                        form.submit();
                    });
                },

                onError: function (err) {
                    console.error(err);
                    alert("Payment failed. Please try again.");
                }
            }).render('#paypal-button-container');
        }
    </script>
}