@model ServiceInfo
@{
    ViewData["Title"] = "Service Details";
}

<div class="container mt-4 mb-5">

    @if (Model == null)
    {
        <div class="text-center">
            <h3>No service found</h3>
        </div>
        return;
    }

    <div class="card shadow-lg border-0">

        <!-- HEADER -->
        <div class="card-body border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="fw-bold mb-0">@Model.ServiceName</h3>

                <span class="badge rounded-pill px-4 py-2"
                      style="background: linear-gradient(135deg,#6f42c1,#0d6efd); color:white;">
                    @Model.Category
                </span>
            </div>

            <p class="text-muted mt-2 mb-1">@Model.Description</p>

            <!-- ⭐ Rating + Bookings -->
            <div class="text-muted">
                @if (ViewBag.AvgRating > 0)
                {
                    <span>⭐ @ViewBag.AvgRating</span>
                }
                else
                {
                    <span>No ratings yet</span>
                }
                &nbsp;•&nbsp;
                <span>@ViewBag.TotalBookings bookings</span>
            </div>
        </div>

        <div class="row g-0">

            <!-- LEFT SIDE -->
            <div class="col-md-5 p-4">

                <img src="@Model.ImagePath"
                     class="img-fluid rounded w-100 mb-3"
                     alt="@Model.ServiceName"
                     onerror="this.src='https://via.placeholder.com/300x180';" />

                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 border-end">
                                <small class="text-muted">Pricing</small>
                                <div class="fw-bold">₹ @Model.Pricing</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Duration</small>
                                <div class="fw-bold">@Model.Duration</div>
                            </div>
                        </div>

                        <hr class="my-2" />

                        <div class="text-center">
                            <small class="text-muted">Service Area</small>
                            <div class="fw-semibold">
                                @Model.City (@Model.PinCode) · @Model.Radius km
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT SIDE -->
            <div class="col-md-7 p-4">

                <!-- AVAILABILITY -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">Availability</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Working Hours</small>
                            <div>@Model.WorkingHoursStart - @Model.WorkingHoursEnd</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Days</small>
                            <div>@Model.WeeklySchedule</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Time Slots</small>
                        <div>@Model.TimeSlots</div>
                    </div>
                </div>

                <!-- LOCATION -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">Addresses</h6>
                    <div>@Model.Addresses</div>
                </div>

                <!-- PROVIDER -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-2">Service Provider</h6>
                    <div class="border rounded p-3">
                        <div class="fw-semibold">@Model.FullName</div>
                        <div class="text-muted fw-semibold">@Model.BusinessName</div>
                        <div class="mt-2">
                            📧 @Model.Email <br />
                            📞 @Model.Phone
                        </div>
                    </div>
                </div>

                <!-- CTA -->
                <form asp-action="AddToCart"
                      asp-controller="Cart"
                      method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="serviceId" value="@Model.Service_Id" />
                    <button class="py-2 fs-5 btn btn-dark w-100" style="color:white!important">
                        Add to Cart
                    </button>
                </form>

            </div>
        </div>

        <!-- FEEDBACK SECTION -->
        <div class="card-body border-top">
            <h5 class="fw-bold mb-3">Customer Feedback</h5>

            @if (ViewBag.Feedbacks != null && ViewBag.Feedbacks.Count > 0)
            {
                var feedbacks = ViewBag.Feedbacks;
                int showCount = 5;

                @* Display first 2 feedbacks *@
                for (int i = 0; i < Math.Min(showCount, feedbacks.Count); i++)
                {
                    var fb = feedbacks[i];
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between">
                            <strong>@fb.ConsumerName</strong>
                            @if (fb.Rating != null && fb.Rating > 0)
                            {
                                <span class="text-muted">⭐ @fb.Rating</span>
                            }
                        </div>
                        <p class="mb-0 mt-1 text-muted">@fb.Customer_Feedback</p>
                    </div>
                }

                @* Remaining feedbacks hidden in collapse *@
                @if (feedbacks.Count > showCount)
                {
                    <div class="collapse" id="moreFeedbacks">
                        @for (int i = showCount; i < feedbacks.Count; i++)
                        {
                            var fb = feedbacks[i];
                            <div class="border rounded p-3 mb-3">
                                <div class="d-flex justify-content-between">
                                    <strong>@fb.ConsumerName</strong>
                                    @if (fb.Rating != null && fb.Rating > 0)
                                    {
                                        <span class="text-muted">⭐ @fb.Rating</span>
                                    }
                                </div>
                                <p class="mb-0 mt-1 text-muted">@fb.Customer_Feedback</p>
                            </div>
                        }
                    </div>

                    <div class="d-flex justify-content-center">
                        <button class="btn btn-outline-primary btn-sm mt-2"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#moreFeedbacks"
                                aria-expanded="false"
                                aria-controls="moreFeedbacks"
                                id="toggleFeedbackBtn">
                            Show more
                        </button>
                    </div>

                }
            }
            else
            {
                <p class="text-muted">No feedback available for this service.</p>
            }
        </div>

        
        <!---->
    </div>
</div>

@* JS to toggle button text dynamically *@
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var btn = document.getElementById("toggleFeedbackBtn");
        var collapseEl = document.getElementById("moreFeedbacks");

        if (btn && collapseEl) {
            collapseEl.addEventListener("show.bs.collapse", function () {
                btn.textContent = "Show less";
            });
            collapseEl.addEventListener("hide.bs.collapse", function () {
                btn.textContent = "Show more";
            });
        }
    });
</script>